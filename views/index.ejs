<!DOCTYPE html>
<!--<style>-->


<!--</style>-->
<html>
  <head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.3/nv.d3.js" ></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script src="underscore/underscore-min.js"></script>
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.3/nv.d3.css">
    <link rel="stylesheet" type="text/css" href="stylesheets/style.css">
  </head>
  <header>
    <h1>FCC Stock Market</h1>
  </header>
  <body>
    <div class="row">
    <div id="chart" class="inline">
      <svg></svg>
    </div>
    <div id="stocksBox" class="inline">
      <form id="searchForm" class="navbar-form" role="search" action="/addStock" method="post">
        <div class="input-group add-on">
          <input class="form-control" placeholder="Search" name="code" id="code" type="text" required>
          <div class="input-group-btn">
            <button class="btn btn-default" type="submit"><i class="glyphicon glyphicon-plus"></i></button>
          </div>
        </div>
      </form>
    </div>  
    </div>
    <div id="wait" style="display:none;width:69px;height:89px;position:absolute;top:50%;left:50%;padding:2px;"><img src='images/loading.gif' width="64" height="64" /></div>
    
  </body>
<html>


<script>

$(document).ready(function(){
  var stocksData =<%-JSON.stringify(data)%>;
  drawGraph();
  startWS();
  initStockDivs();
  
  $(document).ajaxStart(function(){
      $("#wait").css("display", "block");
  });
  $(document).ajaxComplete(function(){
      $("#wait").css("display", "none");
  });
  
  //////////////////////remove stock//////////////////////////
  $('#stocksBox').on('click','.remove',function() {
    
    // console.log($(this).parent().text(), _.indexOf(stocksData, _.findWhere(stocksData, { key : $(this).parent().text()})));
    var code = $(this).parent().text();
    $.ajax({
      type: "post",
      url: "/deleteStock",
      data: {key: code},
      success: function() {
        console.log("success", $(this).parent().text(), _.indexOf(stocksData, _.findWhere(stocksData, { key : $(this).parent().text()})));
        // var indexOfStock =  _.indexOf(stocksData, _.findWhere(stocksData, { key : $(this).parent().text()}));
        // if(indexOfStock >= 0) {
        //   stocksData.splice(indexOfStock, 1);
        //   drawGraph ();
        // 	$(this).parent().remove();
        // }
        
      },
      error: function(msg) {
        alert(JSON.stringify(msg));
      }
    });
    
    $(this).parent().remove();
  });
  
  $('#searchForm').submit(function(ev){
    ev.preventDefault();
    console.log("form submit");
    $.ajax({
       type: $("#searchForm").attr("method"),
       url: $("#searchForm").attr("action"),
       data: $("#searchForm").serialize(),
       success: function() {
         console.log("add stock success!");
        // data.push(stock);
        // drawGraph ();
       },
       error: function(msg) {
         alert("Incorrect stock code!");
       }
    });
    
  });
  
  function initStockDivs() {
    stocksData.forEach(function(item) {
      addStockDiv(item.key, "");
    });  
  }
  
  function startWS() {
    var socket = io.connect("https://heroku-env-air000.c9users.io:8081");
            socket.on("news", function(data) {
                
                if(data.msg) alert(data.msg);
                socket.emit("my other event", { message : "client emit" } );
            });
            
            socket.on("addStock", function(data) {
              
              stocksData.push(data.stock);
              drawGraph ();
              addStockDiv(data.stock.key, data.discript);
            });
            
            socket.on("disconnect", function() {
              console.log("disconnect");
            });
            
  }
  
  function addStockDiv(code, discript) {
    $('#stocksBox').append('<div class="stockDiv">' + code + '<div class="remove"><i class="glyphicon glyphicon-remove"></i></div></div>');
  }
  function drawGraph () {
    
    nv.addGraph(function() {
      var chart = nv.models.lineWithFocusChart()
                  .x( function(d){ return d3.time.format("%Y-%m-%d").parse(d.x);})
                  .y(function(d){return +d.y;})
                  .useInteractiveGuideline(true);
     
    
      chart.xAxis
        .axisLabel('Date')
        .tickFormat(function(d) { return d3.time.format("%d-%b-%y")(new Date(d)); });
    
      chart.yAxis
        .axisLabel('Price ($)')
        .tickFormat(d3.format(', .1f'));
    
      chart.y2Axis
        .tickFormat(d3.format(', .1f'));
    
      chart.x2Axis
        .tickFormat(function(d) { return d3.time.format("%d-%b-%y")(new Date(d)); });
        
      d3.select('#chart svg')
        .datum(stocksData)
        .transition().duration(1000)
        .call(chart);
        
      nv.utils.windowResize(chart.update);
    
      return chart;
    });
  }
  
});


</script>